<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cat & Rat Detector ğŸ±ğŸ€ | Browser Camera</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at center, #0f172a, #020617);
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
  </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen text-gray-200 font-sans">
  <h1 class="text-3xl font-bold mb-6 text-center text-indigo-400">
    ğŸ±ğŸ€ Cat & Rat Detector using Browser Camera
  </h1>

  <div class="relative flex flex-col items-center bg-gray-800/60 p-6 rounded-2xl shadow-lg backdrop-blur-sm w-11/12 sm:w-3/4 md:w-1/2">
    <div class="relative w-full">
      <video id="video" autoplay playsinline class="rounded-xl border-2 border-gray-600 shadow-lg w-full"></video>
      <canvas id="overlay" class="rounded-xl w-full h-full"></canvas>
    </div>

    <p id="status" class="mt-6 text-lg font-medium text-cyan-400 transition-all duration-500">
      Click the button below to allow camera access.
    </p>

    <button id="permission-btn"
      class="mt-6 px-5 py-2.5 text-lg font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500/50">
      ğŸ¥ Allow Camera Access
    </button>
  </div>

  <footer class="mt-10 text-sm text-gray-500">
    Powered by <span class="text-indigo-400 font-semibold">Flask + YOLOv12</span>
  </footer>

  <script>
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const ctx = overlay.getContext("2d");
    const statusText = document.getElementById("status");
    const permissionBtn = document.getElementById("permission-btn");

    permissionBtn.addEventListener("click", async () => {
      statusText.textContent = "Requesting camera permission...";
      permissionBtn.disabled = true;
      permissionBtn.classList.add("opacity-50", "cursor-not-allowed");

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        statusText.textContent = "âœ… Camera active! Starting detection...";
        permissionBtn.classList.add("hidden");
        startDetection();
      } catch (err) {
        statusText.textContent = "âŒ Camera access denied: " + err.message;
        permissionBtn.disabled = false;
        permissionBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    });

    function startDetection() {
      const canvasHidden = document.createElement("canvas");
      const hiddenCtx = canvasHidden.getContext("2d");

      async function captureFrame() {
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          setTimeout(captureFrame, 500);
          return;
        }

        // Sync overlay size
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        canvasHidden.width = video.videoWidth;
        canvasHidden.height = video.videoHeight;

        // Draw frame
        hiddenCtx.drawImage(video, 0, 0, canvasHidden.width, canvasHidden.height);
        const imageData = canvasHidden.toDataURL("image/jpeg", 0.5);

        try {
          const res = await fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: imageData }),
          });
          const data = await res.json();

          // Clear old drawings
          ctx.clearRect(0, 0, overlay.width, overlay.height);

          if (data.detected && data.boxes) {
            drawBoxes(data.boxes);
          }

          // Update status
          if (data.detected) {
            if (data.label === "cat") {
              statusText.textContent = "ğŸ± Cat detected â€” barking!";
              statusText.className = "mt-6 text-lg font-semibold text-green-400 transition-all";
              video.className = "rounded-xl border-4 border-green-400 shadow-lg w-full";
            } else if (data.label === "rat") {
              statusText.textContent = "ğŸ€ Rat detected â€” meowing!";
              statusText.className = "mt-6 text-lg font-semibold text-yellow-400 transition-all";
              video.className = "rounded-xl border-4 border-yellow-400 shadow-lg w-full";
            }
          } else {
            statusText.textContent = "No cat or rat detected.";
            statusText.className = "mt-6 text-lg font-medium text-cyan-400 transition-all";
            video.className = "rounded-xl border-2 border-gray-600 shadow-lg w-full";
          }
        } catch (err) {
          statusText.textContent = "âš ï¸ Error: " + err.message;
          statusText.className = "mt-6 text-lg font-medium text-red-400 transition-all";
        }

        setTimeout(captureFrame, 1000);
      }

      captureFrame();
    }

    function drawBoxes(boxes) {
      boxes.forEach((box) => {
        const { x1, y1, x2, y2, label } = box;
        const color = label === "cat" ? "#22c55e" : "#facc15"; // green or yellow

        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.font = "16px sans-serif";
        ctx.fillStyle = color;
        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
        ctx.fillText(label.toUpperCase(), x1 + 5, y1 - 8);
      });
    }
  </script>
</body>
</html>
